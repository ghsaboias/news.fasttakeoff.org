# API Reports 500 Error Fix

## Issue Summary

The `/api/reports` endpoint was returning a 500 error when trying to fetch specific reports with URLs like:
```
/api/reports?channelId=1258942836296912916&reportId=d3962dc1-7539-40fe-9819-72c31a977443:1
```

## Root Causes Identified

### 1. Performance Issue in `getReportTimeframe` Method
**Problem**: The `getReportTimeframe` method called `getAllReportsFromCache()` which fetches ALL reports from all channels and timeframes just to find one report's timeframe. This is extremely expensive and likely causing timeouts.

**Code Path**:
```typescript
getReportAndMessages() -> getReportTimeframe() -> getReport() -> getAllReportsFromCache()
```

### 2. Malformed ReportId with `:1` Suffix
**Problem**: The reportId contained a `:1` suffix which doesn't match the UUID format generated by `uuidv4()`. This could be from URL encoding issues or routing artifacts.

## Fixes Implemented

### 1. Optimized `getReportAndMessages` Method
**File**: `src/lib/data/report-generator-service.ts`

**Before**:
```typescript
async getReportAndMessages(channelId: string, reportId: string, timeframe?: TimeframeKey) {
    const effectiveTimeframe = timeframe || await this.getReportTimeframe(reportId) || '2h';
    // ... expensive getAllReportsFromCache call
}
```

**After**:
```typescript
async getReportAndMessages(channelId: string, reportId: string, timeframe?: TimeframeKey) {
    // If timeframe provided, use it directly
    if (timeframe) {
        const cachedReports = await this.cacheService.getReportsFromCache(channelId, timeframe);
        // ... efficient single-channel search
    }
    
    // If no timeframe, try common timeframes efficiently
    const timeframesToTry: TimeframeKey[] = ['2h', '6h'];
    for (const tf of timeframesToTry) {
        const cachedReports = await this.cacheService.getReportsFromCache(channelId, tf);
        // ... search within channel-specific cache
    }
}
```

**Benefits**:
- Eliminates expensive cross-channel searches
- Searches only within the specific channel's cache
- Tries common timeframes in order of likelihood
- Massive performance improvement

### 2. Added Defensive Input Handling
**File**: `src/app/api/reports/route.ts`

**Added sanitization for reportId**:
```typescript
// Clean up reportId - remove any trailing colons and numbers (like :1)
// This handles potential URL encoding issues or routing artifacts
reportId = reportId.replace(/:[\d]+$/, '').trim();

if (!reportId) throw new Error('Invalid reportId after cleaning');

console.log(`[API] Fetching report: channelId=${channelId}, reportId=${reportId}`);
```

**Benefits**:
- Handles malformed reportIds with colons and suffixes
- Provides better error messages
- Adds logging for debugging

### 3. Enhanced Client-Side Error Handling
**File**: `src/app/current-events/[channelId]/[reportId]/ReportClient.tsx`

**Added comprehensive error handling**:
```typescript
try {
    console.log(`[CLIENT] Fetching report: channelId=${channelId}, reportId=${reportId}`);
    const reportResponse = await fetch(`/api/reports?channelId=${channelId}&reportId=${reportId}`);
    
    if (!reportResponse.ok) {
        const errorText = await reportResponse.text();
        console.error(`[CLIENT] API Error ${reportResponse.status}:`, errorText);
        throw new Error(`Failed to fetch report: ${reportResponse.status} - ${errorText}`);
    }
    
    const data = await reportResponse.json();
    console.log(`[CLIENT] Successfully fetched report:`, data.report?.headline || 'No headline');
    // ...
} catch (error) {
    console.error('[CLIENT] Error fetching report and messages:', error);
    toast.error('Failed to load report. Please try again.');
}
```

**Benefits**:
- Detailed error logging for debugging
- User-friendly error messages
- Better error recovery

## Performance Impact

### Before (Expensive Operation)
```
User Request -> getReportAndMessages() -> getReportTimeframe() -> getAllReportsFromCache()
                                                                    ↓
                                                        Fetches ALL reports from ALL channels
                                                        (potentially thousands of reports)
                                                                    ↓
                                                        Searches through entire dataset
                                                                    ↓
                                                        High latency/timeout risk
```

### After (Optimized Operation)
```
User Request -> getReportAndMessages() -> Try specific channel caches for common timeframes
                                          ↓
                                   Fetch only reports for specific channel+timeframe
                                          ↓
                                   Search within small, relevant dataset
                                          ↓
                                   Fast response
```

## Expected Results

1. **Elimination of 500 errors** caused by timeouts from expensive operations
2. **Significant performance improvement** for report fetching
3. **Better handling of malformed URLs** with reportId suffixes
4. **Improved debugging** with detailed logging
5. **Better user experience** with proper error messages

## Testing

To test the fix:
1. Start the development server: `npm run preview:patch:test`
2. Try the previously failing URL: `/api/reports?channelId=1258942836296912916&reportId=d3962dc1-7539-40fe-9819-72c31a977443:1`
3. Check browser console for detailed logging
4. Verify the report loads successfully

## Additional Notes

- The fix maintains backward compatibility
- No breaking changes to the API interface
- The optimization follows the existing caching patterns
- Error handling is non-intrusive and provides helpful debugging information