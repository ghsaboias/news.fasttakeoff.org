<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fast Takeoff News - Interactive Newsletter Builder</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f8f9fa;
            color: #333;
        }
        .controls {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .controls h2 {
            margin-top: 0;
            color: #1f2937;
        }
        .selections {
            background: #f3f4f6;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 20px;
            min-height: 100px;
        }
        .selection-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
            padding: 10px;
            background: white;
            border-radius: 4px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .selection-item img {
            width: 50px;
            height: 50px;
            object-fit: cover;
            border-radius: 4px;
        }
        .newsletter {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #1f2937 0%, #111827 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        .header h1 {
            margin: 0;
            font-size: 28px;
            font-weight: 700;
            background: linear-gradient(90deg, #10b981, #14b8a6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .header p {
            margin: 10px 0 0 0;
            opacity: 0.9;
            font-size: 16px;
        }
        .content {
            padding: 30px;
        }
        .welcome {
            font-size: 16px;
            margin-bottom: 25px;
            color: #4b5563;
        }
        .brief-header {
            background: linear-gradient(90deg, #1f2937, #374151);
            color: white;
            padding: 20px 30px;
            margin: 0 -30px 25px -30px;
        }
        .brief-header h2 {
            margin: 0;
            font-size: 22px;
            font-weight: 600;
        }
        .brief-header .date {
            opacity: 0.8;
            font-size: 14px;
            margin-top: 5px;
        }
        .story {
            margin-bottom: 25px;
            border-left: 4px solid #e5e7eb;
            padding-left: 20px;
            position: relative;
        }
        .story.politics { border-left-color: #fbbf24; }
        .story.conflict { border-left-color: #ef4444; }
        .story.diplomacy { border-left-color: #3b82f6; }
        .story.military { border-left-color: #fbbf24; }
        .story.intelligence { border-left-color: #ef4444; }
        
        .story-header {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }
        .story-emoji {
            font-size: 18px;
            margin-right: 8px;
        }
        .story-title {
            font-weight: 700;
            font-size: 18px;
            color: #1f2937;
            margin: 0;
        }
        .story-location {
            color: #6b7280;
            font-style: italic;
            font-size: 14px;
            margin-bottom: 10px;
        }
        .story-content {
            color: #374151;
            font-size: 15px;
            line-height: 1.6;
        }
        .story-image {
            width: 100%;
            height: auto;
            background: #f3f4f6;
            border-radius: 6px;
            margin: 15px 0;
            overflow: hidden;
            position: relative;
        }
        .story-image img {
            width: 100%;
            height: auto;
            display: block;
        }
        .story-image.placeholder {
            display: flex;
            align-items: center;
            justify-content: center;
            color: #6b7280;
            font-style: italic;
            cursor: pointer;
            border: 2px dashed #d1d5db;
            height: 200px;
        }
        .story-image.placeholder:hover {
            border-color: #10b981;
            background: #f0fdf4;
        }
        .image-gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 10px;
            margin: 15px 0;
            max-height: 300px;
            overflow-y: auto;
            background: #f9fafb;
            padding: 15px;
            border-radius: 6px;
            border: 1px solid #e5e7eb;
        }
        .image-option {
            width: 100%;
            height: 80px;
            object-fit: cover;
            border-radius: 4px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s;
        }
        .image-option:hover {
            border-color: #10b981;
            transform: scale(1.05);
        }
        .image-option.selected {
            border-color: #10b981;
            box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.2);
        }
        .placeholder-img {
            width: 120px;
            height: 80px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 14px;
            text-align: center;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s;
        }
        .placeholder-content {
            line-height: 1.2;
        }
        .placeholder-img:nth-child(1) { background: #dc2626; }
        .placeholder-img:nth-child(2) { background: #1f2937; }
        .placeholder-img:nth-child(3) { background: #059669; }
        .placeholder-img:nth-child(4) { background: #7c3aed; }
        .placeholder-img:nth-child(5) { background: #dc2626; }
        .placeholder-img:nth-child(6) { background: #374151; }
        .placeholder-img:nth-child(7) { background: #0369a1; }
        .placeholder-img:nth-child(8) { background: #dc2626; }
        .gallery-toggle {
            background: #10b981;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin: 10px 0;
        }
        .gallery-toggle:hover {
            background: #059669;
        }
        .gallery-hidden {
            display: none;
        }
        .insight {
            background: #f3f4f6;
            border-radius: 6px;
            padding: 20px;
            margin: 25px 0;
            border-left: 4px solid #10b981;
        }
        .insight-title {
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 10px;
        }
        .cta {
            background: #f8fafc;
            padding: 20px;
            border-radius: 6px;
            margin: 25px 0;
            text-align: center;
        }
        .footer {
            background: #f8f9fa;
            padding: 20px 30px;
            margin: 25px -30px 0 -30px;
            font-size: 14px;
            color: #6b7280;
        }
        .signature {
            margin: 20px 0;
            font-style: italic;
        }
        .unsubscribe {
            font-size: 12px;
            color: #9ca3af;
            margin-top: 15px;
        }
        .export-btn {
            background: #1f2937;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin-top: 10px;
        }
        .export-btn:hover {
            background: #374151;
        }
    </style>
</head>
<body>
    <div class="controls">
        <h2>üé® Interactive Newsletter Builder</h2>
        <p>Generate fresh newsletter data from Discord channels, then select images for each story.</p>
        
        <button class="export-btn" onclick="generateData()" id="generateDataBtn" style="background: #059669; margin-right: 10px;">üîÑ Get Newsletter Data</button>
        
        <div id="statusMessage"></div>
        
        <h3>Selected Images:</h3>
        <div class="selections" id="selections">
            <p style="color: #6b7280; font-style: italic;">No images selected yet. Click on images in the stories below to choose them.</p>
        </div>
        
        <button class="export-btn" onclick="exportNewsletter()">üìß Export Final Newsletter HTML</button>
    </div>

    <div class="newsletter" id="newsletter">
        <div class="header">
            <h1>Fast Takeoff News</h1>
            <p>AI-Powered Intelligence Briefing</p>
        </div>
        
        <div class="content">
            <div class="welcome">
                <p><strong>Hi there,</strong></p>
                <p>Welcome to Fast Takeoff News! You're now part of a small, exclusive group of early subscribers getting AI-powered news intelligence straight from global sources.</p>
                <p><strong>What you'll get:</strong> Real-time analysis of breaking news from channels monitoring everything from US politics to Myanmar resistance movements, compiled by AI and verified by human oversight.</p>
            </div>
            
            <div class="brief-header">
                <h2>Today's Intelligence Brief</h2>
                <div class="date">September 5, 2025</div>
            </div>
            
            
            <div class="cta">
                <p><strong>What's next:</strong> I'm personally curating these briefings and would love your feedback. What type of analysis interests you most? Geopolitical trends? Economic intelligence? Regional conflicts?</p>
                <p>Just reply to this email - I read every response personally.</p>
            </div>
            
            <div class="signature">
                <p>Best,<br>
                <strong>Guilherme</strong><br>
                Founder, Fast Takeoff News</p>
            </div>
            
            <div class="footer">
                <p><strong>P.S.</strong> - If you know someone who'd value real-time intelligence analysis, share: <a href="https://news.fasttakeoff.org">news.fasttakeoff.org</a></p>
                
                <div class="unsubscribe">
                    <p><em>You're receiving this because you signed up at news.fasttakeoff.org. Unsubscribe anytime.</em></p>
                </div>
            </div>
        </div>
    </div>

    <script>
        let selectedImages = {};
        let newsletterData = null;
        
        function toggleGallery(storyId) {
            const gallery = document.getElementById(`gallery-${storyId}`);
            gallery.classList.toggle('gallery-hidden');
        }
        
        function selectImage(storyId, element) {
            // Check if this image is already selected
            const isCurrentlySelected = element.classList.contains('selected');
            
            // Remove previous selection for this story
            const currentGallery = document.getElementById(`gallery-${storyId}`);
            currentGallery.querySelectorAll('.image-option').forEach(img => {
                img.classList.remove('selected');
            });
            
            // If it was already selected, deselect it (don't re-select)
            if (isCurrentlySelected) {
                // Remove from selectedImages and reset placeholder
                delete selectedImages[storyId];
                
                // Reset to placeholder
                const storyImage = document.querySelector(`[data-target="${storyId}"]`);
                if (storyImage) {
                    storyImage.innerHTML = '<span>Click to select image</span>';
                    storyImage.classList.add('placeholder');
                }
                
                updateSelections();
                return;
            }
            
            // Select new image
            element.classList.add('selected');
            
            // Handle placeholder vs real images
            const isPlaceholder = element.classList.contains('placeholder-img');
            let content = '';
            let bgColor = '';
            
            if (isPlaceholder) {
                const placeholderContent = element.querySelector('.placeholder-content');
                content = placeholderContent ? placeholderContent.innerHTML : element.textContent;
                bgColor = getComputedStyle(element).backgroundColor;
            }
            
            // Store selection
            selectedImages[storyId] = {
                src: element.src || content,
                description: element.dataset.description || element.textContent,
                isPlaceholder: isPlaceholder,
                backgroundColor: bgColor,
                content: content
            };
            
            // Update the story image
            const storyImage = document.querySelector(`[data-target="${storyId}"]`);
            if (isPlaceholder) {
                storyImage.innerHTML = `<div style="width: 100%; height: 100%; background: ${bgColor}; display: flex; align-items: center; justify-content: center; color: white; font-size: 32px; text-align: center;">${content}</div>`;
                storyImage.classList.remove('placeholder');
            } else if (element.src) {
                storyImage.innerHTML = `<img src="${element.src}" alt="${element.dataset.description}" style="width: 100%; height: 100%; object-fit: cover;" />`;
                storyImage.classList.remove('placeholder');
            }
            
            // Update selections display
            updateSelections();
            
            // Hide gallery
            toggleGallery(storyId);
        }
        
        function updateSelections() {
            const selectionsDiv = document.getElementById('selections');
            if (Object.keys(selectedImages).length === 0) {
                selectionsDiv.innerHTML = '<p style="color: #6b7280; font-style: italic;">No images selected yet. Click on images in the stories below to choose them.</p>';
                return;
            }
            
            let html = '';
            for (const [storyId, image] of Object.entries(selectedImages)) {
                const storyTitle = document.querySelector(`[data-story="${storyId}"] .story-title`).textContent;
                html += `
                    <div class="selection-item">
                        ${image.isPlaceholder ? 
                            `<div style="width: 50px; height: 50px; background: #374151; border-radius: 4px; display: flex; align-items: center; justify-content: center; color: white; font-size: 12px;">${image.src}</div>` :
                            `<img src="${image.src}" alt="${image.description}" />`
                        }
                        <div>
                            <strong>${storyTitle}</strong><br>
                            <small>${image.description}</small>
                        </div>
                    </div>
                `;
            }
            selectionsDiv.innerHTML = html;
        }
        
        async function generateData() {
            const btn = document.getElementById('generateDataBtn');
            const status = document.getElementById('statusMessage');
            
            btn.disabled = true;
            btn.textContent = 'üîÑ Generating Data...';
            status.innerHTML = '<p style="color: #059669; margin: 10px 0;">‚è≥ Running newsletter data generation script...</p>';
            
            try {
                const response = await fetch('/api/generate-newsletter', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // If data was returned, use it directly
                    if (result.data) {
                        newsletterData = result.data;
                        buildDynamicNewsletter();
                        status.innerHTML = '<p style="color: #059669; margin: 10px 0;">‚úÖ Newsletter loaded! Select images and export when ready.</p>';
                    } else {
                        status.innerHTML = '<p style="color: #059669; margin: 10px 0;">‚úÖ Newsletter data generated successfully!</p>';
                    }
                } else {
                    throw new Error(result.error || 'Unknown error');
                }
                
            } catch (error) {
                console.error('Generation error:', error);
                status.innerHTML = `<div style="background: #fef2f2; border: 1px solid #fca5a5; border-radius: 6px; padding: 15px; color: #dc2626; margin: 10px 0;"><strong>Error:</strong> ${error.message}<br><small>Make sure the dev server is running and try again.</small></div>`;
            } finally {
                btn.disabled = false;
                btn.textContent = 'üîÑ Get Newsletter Data';
            }
        }
        
        async function loadNewsletter() {
            const btn = document.getElementById('loadNewsletterBtn');
            const status = document.getElementById('statusMessage');
            
            btn.disabled = true;
            btn.textContent = 'üì∞ Loading...';
            status.innerHTML = '<p style="color: #1f2937; margin: 10px 0;">‚è≥ Loading fresh newsletter data...</p>';
            
            try {
                const response = await fetch('/newsletter-data.json');
                if (!response.ok) {
                    throw new Error('Newsletter data not found. Please run: node scripts/generate-newsletter-data.js');
                }
                
                newsletterData = await response.json();
                buildDynamicNewsletter();
                
                status.innerHTML = '<p style="color: #059669; margin: 10px 0;">‚úÖ Newsletter loaded! Select images and export when ready.</p>';
                
            } catch (error) {
                status.innerHTML = '<div style="background: #fef2f2; border: 1px solid #fca5a5; border-radius: 6px; padding: 15px; color: #dc2626; margin: 10px 0;"><strong>Error:</strong> ' + error.message + '</div>';
            } finally {
                btn.disabled = false;
                btn.textContent = 'üì∞ Generate Newsletter';
            }
        }
        
        function buildDynamicNewsletter() {
            if (!newsletterData) return;
            
            // Update date
            const dateElement = document.querySelector('.brief-header .date');
            if (dateElement) {
                dateElement.textContent = newsletterData.date;
            }
            
            // Clear existing stories and rebuild
            const newsletter = document.getElementById('newsletter');
            const content = newsletter.querySelector('.content');
            
            // Keep welcome and brief header, remove old stories
            const storiesStart = content.querySelector('.story');
            if (storiesStart) {
                let nextElement = storiesStart;
                while (nextElement && !nextElement.classList.contains('insight')) {
                    const toRemove = nextElement;
                    nextElement = nextElement.nextElementSibling;
                    toRemove.remove();
                }
            }
            
            // Insert new stories before the insight section
            const insightElement = content.querySelector('.insight');
            newsletterData.stories.forEach((story, index) => {
                const storyElement = createDynamicStoryElement(story, index);
                content.insertBefore(storyElement, insightElement);
            });
            
            // Reset selections
            selectedImages = {};
            updateSelections();
        }
        
        function removeStory(storyId) {
            const storyElement = document.querySelector(`[data-story="${storyId}"]`);
            if (storyElement) {
                // Remove from selectedImages if it exists
                if (selectedImages[storyId]) {
                    delete selectedImages[storyId];
                }
                // Remove from DOM
                storyElement.remove();
                // Update selections display
                updateSelections();
            }
        }
        
        function updateStoryContent(storyId) {
            const select = document.getElementById(`content-length-${storyId}`);
            const contentDiv = document.getElementById(`content-${storyId}`);
            const storyIndex = parseInt(storyId.split('-')[1]);
            const story = newsletterData.stories[storyIndex];
            
            if (!story || !contentDiv) return;
            
            const fullBody = story.body || story.content || '';
            let displayContent;
            
            switch(select.value) {
                case 'brief':
                    displayContent = fullBody.substring(0, 150) + (fullBody.length > 150 ? '...' : '');
                    break;
                case 'medium':
                    displayContent = fullBody.substring(0, 300) + (fullBody.length > 300 ? '...' : '');
                    break;
                case 'full':
                    displayContent = fullBody;
                    break;
                default:
                    displayContent = fullBody.substring(0, 300) + (fullBody.length > 300 ? '...' : '');
            }
            
            contentDiv.textContent = displayContent;
        }
        
        function createDynamicStoryElement(story, index) {
            const storyDiv = document.createElement('div');
            storyDiv.className = `story ${story.category}`;
            storyDiv.dataset.story = `story-${index}`;
            
            const hasImages = story.availableImages && story.availableImages.length > 0;
            
            storyDiv.innerHTML = `
                <div class="story-header">
                    <span class="story-emoji">${story.emoji}</span>
                    <h3 class="story-title">${story.title}</h3>
                    <button class="remove-story" onclick="removeStory('story-${index}')" style="margin-left: auto; background: #ef4444; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 12px;">‚úï Remove</button>
                </div>
                <div class="story-location">${story.location}</div>
                
                <div class="story-image placeholder" data-target="story-${index}" onclick="toggleGallery('story-${index}')">
                    <span>Click to select image</span>
                </div>
                
                <div class="content-controls" style="background: #f3f4f6; padding: 10px; border-radius: 6px; margin: 10px 0;">
                    <label for="content-length-story-${index}" style="display: block; font-weight: 600; margin-bottom: 5px; font-size: 14px;">Content Length:</label>
                    <select id="content-length-story-${index}" onchange="updateStoryContent('story-${index}')" style="width: 100%; padding: 5px; border-radius: 4px; border: 1px solid #d1d5db;">
                        <option value="brief">Brief (150 chars)</option>
                        <option value="medium" selected>Medium (300 chars)</option>
                        <option value="full">Full content</option>
                    </select>
                </div>
                
                <div class="story-content" id="content-story-${index}">
                    ${story.content}
                </div>
                
                <button class="gallery-toggle" onclick="toggleGallery('story-${index}')">
                    Choose Image${hasImages ? ` (${story.availableImages.length} available)` : ' (No images)'}
                </button>
                <div class="image-gallery" id="gallery-story-${index}">
                    ${hasImages ? 
                        story.availableImages.map(img => `
                            <img class="image-option" 
                                 src="/api/image-proxy?url=${encodeURIComponent(img.url)}" 
                                 onclick="selectImage('story-${index}', this)" 
                                 data-description="${img.description || img.filename}"
                                 data-author="${img.author || 'unknown'}"
                                 title="${img.description || img.filename}" />
                        `).join('') :
                        '<p style="color: #6b7280; font-style: italic; padding: 20px; text-align: center;">No images available for this story</p>'
                    }
                </div>
            `;
            
            return storyDiv;
        }
        
        function exportNewsletter() {
            if (!newsletterData && Object.keys(selectedImages).length === 0) {
                alert('Please generate newsletter first');
                return;
            }
            // Clone the newsletter without the controls
            const newsletterClone = document.getElementById('newsletter').cloneNode(true);
            
            // Remove UI-only elements from export
            newsletterClone.querySelectorAll('.gallery-toggle').forEach(el => el.remove());
            newsletterClone.querySelectorAll('.image-gallery').forEach(el => el.remove());
            newsletterClone.querySelectorAll('.remove-story').forEach(el => el.remove());
            newsletterClone.querySelectorAll('.content-controls').forEach(el => el.remove());
            
            // Remove placeholder images that weren't replaced
            newsletterClone.querySelectorAll('.story-image.placeholder').forEach(el => {
                if (el.querySelector('span') && el.querySelector('span').textContent.includes('Click to select')) {
                    el.remove();
                }
            });
            
            // Create final HTML
            const finalHtml = `<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fast Takeoff News Newsletter</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; line-height: 1.6; max-width: 600px; margin: 0 auto; padding: 0; background-color: #f8f9fa; color: #333; }
        .newsletter { background: white; }
        .header { background: linear-gradient(135deg, #1f2937 0%, #111827 100%); color: white; padding: 30px; text-align: center; }
        .header h1 { margin: 0; font-size: 28px; font-weight: 700; background: linear-gradient(90deg, #10b981, #14b8a6); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        .header p { margin: 10px 0 0 0; opacity: 0.9; font-size: 16px; }
        .content { padding: 30px; }
        .welcome { font-size: 16px; margin-bottom: 25px; color: #4b5563; }
        .brief-header { background: linear-gradient(90deg, #1f2937, #374151); color: white; padding: 20px 30px; margin: 0 -30px 25px -30px; }
        .brief-header h2 { margin: 0; font-size: 22px; font-weight: 600; }
        .brief-header .date { opacity: 0.8; font-size: 14px; margin-top: 5px; }
        .story { margin-bottom: 25px; border-left: 4px solid #e5e7eb; padding-left: 20px; }
        .story.politics { border-left-color: #fbbf24; }
        .story.conflict { border-left-color: #ef4444; }
        .story.diplomacy { border-left-color: #3b82f6; }
        .story.military { border-left-color: #fbbf24; }
        .story.intelligence { border-left-color: #ef4444; }
        .story-header { display: flex; align-items: center; margin-bottom: 8px; }
        .story-emoji { font-size: 18px; margin-right: 8px; }
        .story-title { font-weight: 700; font-size: 18px; color: #1f2937; margin: 0; }
        .story-location { color: #6b7280; font-style: italic; font-size: 14px; margin-bottom: 10px; }
        .story-content { color: #374151; font-size: 15px; line-height: 1.6; }
        .story-image { width: 100%; height: auto; border-radius: 6px; margin: 15px 0; overflow: hidden; }
        .story-image img { width: 100%; height: auto; display: block; }
        .insight { background: #f3f4f6; border-radius: 6px; padding: 20px; margin: 25px 0; border-left: 4px solid #10b981; }
        .insight-title { font-weight: 600; color: #1f2937; margin-bottom: 10px; }
        .cta { background: #f8fafc; padding: 20px; border-radius: 6px; margin: 25px 0; text-align: center; }
        .footer { background: #f8f9fa; padding: 20px 30px; margin: 25px -30px 0 -30px; font-size: 14px; color: #6b7280; }
        .signature { margin: 20px 0; font-style: italic; }
        .unsubscribe { font-size: 12px; color: #9ca3af; margin-top: 15px; }
    </style>
</head>
<body>
    ${newsletterClone.outerHTML}
</body>
</html>`;
            
            // Download the file
            const blob = new Blob([finalHtml], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'fast-takeoff-newsletter-' + new Date().toISOString().split('T')[0] + '.html';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            // Also log selections to console for debugging
            console.log('Selected images:', selectedImages);
        }
    </script>
</body>
</html>